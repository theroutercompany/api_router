file: pkg/gateway/runtime/runtime.go
title: pkg/gateway/runtime/runtime.go
overview:
  what: |
    Composes configuration, readiness checking, metrics registry, and the HTTP server into a single lifecycle object (`Runtime`).

    This package is the "composition root" for gateway execution: it builds the server and (optionally) an admin control-plane server.
  why: |
    The gateway needs a reusable runtime that can be:
    - started/stopped by the CLI
    - embedded as a library
    - managed by a daemon wrapper

    Keeping lifecycle orchestration here avoids duplicating startup/shutdown/reload logic across entrypoints.
  how: |
    - `New()` builds the server, readiness checker, and metrics registry.
    - `Start()` runs the public server (and optionally the admin server) in the background.
    - `Wait()` blocks until shutdown and returns the terminal error.
    - `Shutdown()` requests graceful shutdown.
    - `Reload()` rebuilds dependencies with a new config (only when not running).
  notes: |
    The admin server is intentionally separated from the public listener. It should be bound to loopback or protected by `admin.token` and allowlists.
symbols:
  func New:
    what: Constructs a `Runtime` from an already-loaded `gatewayconfig.Config`.
    why: Separates config loading from runtime composition so callers can control where config comes from (CLI, tests, embedding).
    how: Initializes logger/boot time/admin allowlist, applies `Option`s, then calls `buildComponents` to create the server/checker/metrics registry.
    notes: ""
  func WithLogger:
    what: Runtime option that overrides the logger used by the runtime and underlying server.
    why: Allows CLIs/services to inject their own structured logger configuration.
    how: Sets `Runtime.logger` when the provided logger is non-nil.
    notes: ""
  func WithReloadFunc:
    what: Runtime option that registers a callback invoked by the admin server on reload requests.
    why: The runtime itself does not know how to re-read config (file watching, env layering, etc.); the caller provides that policy.
    how: Sets `Runtime.reloadFn`, which is called by the `POST /__admin/reload` handler.
    notes: ""
  func buildComponents:
    what: Internal helper that builds the server, readiness checker, and metrics registry from config.
    why: Keeps `New()` and `Reload()` small while centralizing dependency construction and invariants.
    how: Builds a readiness `http.Client` (with per-upstream TLS transports), creates a `health.Checker`, optionally creates a metrics registry, then constructs `gatewayserver.Server`.
    notes: ""
  func buildReadinessTLSConfig:
    what: Builds a `tls.Config` for readiness probing based on `gatewayconfig.TLSConfig`.
    why: Readiness probes may need custom CA bundles or client certificates (mTLS) depending on upstream requirements.
    how: Sets safe defaults (TLS 1.2+, h2/http1.1), optionally loads a CA bundle, optionally loads a client certificate/key pair, and returns an error for partial mTLS config.
    notes: ""
  func defaultHTTPTransport:
    what: Returns a clone of `http.DefaultTransport` when possible, otherwise a new `http.Transport`.
    why: Cloning preserves sane defaults (proxy, keep-alives, dialer settings) while allowing per-upstream TLS customization without mutating global state.
    how: Type-asserts `http.DefaultTransport` to `*http.Transport` and calls `Clone()`.
    notes: ""
  func hostFromURL:
    what: Extracts the `Host` portion from a base URL string.
    why: Readiness uses host-specific transports for TLS settings; the host is the stable key for transport selection.
    how: Parses the URL and returns `parsed.Host`, returning an error for empty/invalid URLs.
    notes: ""
  func parseAllowList:
    what: Parses `admin.allow` entries into CIDRs (`*net.IPNet`) for IP-based admin authorization.
    why: When no admin token is configured, access is restricted to loopback or explicitly allowed networks.
    how: Accepts CIDR strings (via `net.ParseCIDR`) and single IPs (converted to /32 or /128).
    notes: ""
  method (*Runtime).AdminAddr:
    what: Returns the bound admin server address (host:port) when enabled.
    why: Helpful when the admin listener is configured with an ephemeral port or needs to be surfaced to callers/tests.
    how: Returns `Runtime.adminAddr` guarded by the runtime mutex.
    notes: ""
  method (*Runtime).Config:
    what: Returns the runtime's current configuration snapshot.
    why: Allows admin/status handlers and callers to report current settings without exposing internal mutation.
    how: Returns a copy of `Runtime.cfg` under the runtime mutex.
    notes: ""
  method (*Runtime).Reload:
    what: Rebuilds runtime dependencies using a new configuration while the runtime is not running.
    why: Replacing server/checker/metrics while serving traffic is unsafe; reload is a controlled, stop-the-world operation.
    how: Refuses when running (`ErrReloadWhileRunning`), calls `buildComponents`, then swaps `cfg/server/checker/registry` and recomputes the admin allowlist.
    notes: ""
  method (*Runtime).Run:
    what: Convenience method that calls `Start(ctx)` then `Wait()`.
    why: Common CLI pattern; keeps call sites simple.
    how: Delegates to `Start` and then blocks on `Wait`.
    notes: ""
  method (*Runtime).Shutdown:
    what: Requests graceful shutdown of the runtime when running.
    why: Provides a structured shutdown path for CLIs, daemons, and embedding (tests/servers).
    how: Cancels the base context, shuts down the admin server (if present), then calls the underlying server's `Shutdown(ctx)`.
    notes: ""
  method (*Runtime).Start:
    what: Starts serving the public gateway server (and optionally the admin server) in the background.
    why: Separates "start" from "wait" to support daemons and embedding where the caller controls the main loop.
    how: Creates a derived context, starts `gatewayserver.Server.Start` in a goroutine, and conditionally starts the admin server based on config.
    notes: ""
  method (*Runtime).Wait:
    what: Blocks until the runtime stops and returns the terminal error.
    why: Provides a single place to normalize shutdown behavior and clean up internal state.
    how: Waits for either server or admin errors, treats `context.Canceled` as nil, and resets internal fields (channels, cancel func, admin server state).
    notes: ""
  method (*Runtime).adminAuth:
    what: Wraps an admin handler with authorization checks.
    why: Keeps the three admin endpoints consistent and avoids repetitive auth boilerplate.
    how: Calls `authorizeAdmin` and invokes the handler only if authorized.
    notes: ""
  method (*Runtime).authorizeAdmin:
    what: Implements admin authorization based on either bearer token or IP allowlist.
    why: Admin endpoints can mutate/report runtime state and must be protected.
    how: If `admin.token` is set, requires an Authorization header with a Bearer token matching the configured token; otherwise allows loopback or entries in `admin.allow`.
    notes: ""
  method (*Runtime).handleAdminConfig:
    what: Admin handler that returns the current config as JSON with secrets redacted.
    why: Enables debugging the running configuration without leaking secrets.
    how: Copies the config, clears `auth.secret` and `admin.token`, and JSON-encodes the result.
    notes: ""
  method (*Runtime).handleAdminReload:
    what: Admin handler that requests a reload via the caller-provided reload callback.
    why: The runtime doesn't know how to reload configuration sources; this endpoint triggers the caller's policy (watcher, SIGHUP, etc.).
    how: Requires POST, ensures `reloadFn` exists, invokes it, and returns a JSON "accepted" response or an error.
    notes: ""
  method (*Runtime).handleAdminStatus:
    what: Admin handler that returns runtime status as JSON.
    why: Provides a minimal control-plane "am I alive/what version/what admin address" endpoint.
    how: Reports PID, uptime seconds, build version, and admin listen information.
    notes: ""
  method (*Runtime).startAdminServer:
    what: Starts the admin HTTP server on `cfg.Admin.Listen`.
    why: Keeps control-plane endpoints separate and optionally enabled.
    how: Listens on TCP, registers status/config/reload handlers under `/_ _admin/*`, runs `http.Server.Serve` in a goroutine, and shuts down on context cancellation.
    notes: ""
  method (*upstreamTransport).CloseIdleConnections:
    what: Closes idle connections for the default transport and all per-host transports.
    why: Prevents leaked keep-alives when swapping/reloading readiness transports.
    how: Calls `CloseIdleConnections` on the default transport and iterates through the map.
    notes: ""
  method (*upstreamTransport).RoundTrip:
    what: Selects a per-host transport (when configured) for an outgoing readiness HTTP request.
    why: Allows readiness checks to use custom TLS settings per upstream host while keeping a shared default for others.
    how: If the request host matches `transports[host]`, delegates to that transport; otherwise uses `defaultTransport`.
    notes: ""
  type Option:
    what: Functional option type for configuring `Runtime` construction.
    why: Keeps the `New()` signature stable while allowing opt-in behaviors (logger injection, reload callback).
    how: Options mutate fields on the `Runtime` during `New()`.
    notes: ""
  type Runtime:
    what: The primary lifecycle object that owns the server, readiness checker, metrics registry, and admin server.
    why: Encapsulates concurrency, context cancellation, and shared state so entrypoints don't reimplement lifecycle wiring.
    how: Uses a mutex to guard state transitions and stores channels/cancel funcs for start/wait/shutdown coordination.
    notes: ""
  type upstreamTransport:
    what: A custom `http.RoundTripper` that routes requests to host-specific `*http.Transport` instances.
    why: Per-upstream TLS settings require per-host transport configuration; a single transport cannot represent multiple TLS configs safely.
    how: Implements `RoundTrip` and `CloseIdleConnections` and holds a default transport plus a host-to-transport map.
    notes: ""
  var ErrAlreadyRunning:
    what: Sentinel error returned when `Start()` is called while the runtime is already running.
    why: Prevents multiple goroutines from attempting to start/own the same server lifecycle.
    how: Returned when `Runtime.errCh` is non-nil inside `Start()`.
    notes: ""
  var ErrNotRunning:
    what: Sentinel error returned when `Wait()` is called before the runtime has started.
    why: Makes lifecycle misuse explicit instead of blocking forever or panicking.
    how: Returned when `Runtime.errCh` is nil inside `Wait()`.
    notes: ""
  var ErrReloadWhileRunning:
    what: Sentinel error returned when `Reload()` is called while the runtime is running.
    why: Hot-swapping server dependencies during active serving is unsafe; reload is only supported while stopped.
    how: Returned when `Runtime.errCh` is non-nil inside `Reload()`.
    notes: ""
