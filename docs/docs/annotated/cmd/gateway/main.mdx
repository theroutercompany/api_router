---
title: "cmd/gateway/main.go"
---

<!--
Generated by `go run ./cmd/docsgen`.
Do not edit this file directly.
Edit commentary in `docs/annotations/cmd/gateway/main.yaml`.
-->

## Source

- Package: `main`
- File: `cmd/gateway/main.go`
- GitHub: https://github.com/theroutercompany/api_router/blob/main/cmd/gateway/main.go

## Overview

**What:** Legacy/compatibility entrypoint that runs the gateway runtime using the default config loader.

**Why:** Maintains backwards compatibility for environments or scripts that still invoke `go run ./cmd/gateway`.

**How:** Calls `gatewayconfig.Load()`, builds a `gatewayruntime.Runtime`, runs it, and flushes logs on exit.


## Imports

### `import` block 1

```go title="cmd/gateway/main.go#L3" showLineNumbers
import (
	"context"
	"errors"
	"fmt"
	"log"

	gatewayconfig "github.com/theroutercompany/api_router/pkg/gateway/config"
	gatewayruntime "github.com/theroutercompany/api_router/pkg/gateway/runtime"
	pkglog "github.com/theroutercompany/api_router/pkg/log"
)
```


## Functions and Methods

### `main`

**What:** Program entrypoint that calls `run(context.Background())` and exits on error.

**Why:** Keeps `main` minimal while allowing the actual logic to be unit-testable in `run`.

**How:** Delegates to `run` and uses `log.Fatalf` on failure.

```go title="cmd/gateway/main.go#L14" showLineNumbers
func main() {
	if err := run(context.Background()); err != nil {
		log.Fatalf("gateway failed: %v", err)
	}
}
```

### `run`

**What:** Loads config, builds the runtime, runs it, and handles shutdown/log flush semantics.

**Why:** Centralizes the legacy run loop and normalizes cancellation to a clean exit.

**How:** Calls `gatewayconfig.Load()`, constructs `gatewayruntime.New(cfg)`, defers `pkglog.Sync()`, then calls `rt.Run(ctx)` and treats `context.Canceled` as nil.

```go title="cmd/gateway/main.go#L20" showLineNumbers
func run(ctx context.Context) error {
	cfg, err := gatewayconfig.Load()
	if err != nil {
		return fmt.Errorf("load config: %w", err)
	}

	rt, err := gatewayruntime.New(cfg)
	if err != nil {
		return fmt.Errorf("build runtime: %w", err)
	}

	defer func() {
		if syncErr := pkglog.Sync(); syncErr != nil {
			log.Printf("logger sync failed: %v", syncErr)
		}
	}()

	if err := rt.Run(ctx); err != nil {
		if errors.Is(err, context.Canceled) {
			return nil
		}
		return err
	}
	return nil
}
```

