---
title: "pkg/gateway/metrics/registry.go"
---

<!--
Generated by `go run ./cmd/docsgen`.
Do not edit this file directly.
Edit commentary in `docs/annotations/pkg/gateway/metrics/registry.yaml`.
-->

## Source

- Package: `metrics`
- File: `pkg/gateway/metrics/registry.go`
- GitHub: https://github.com/theroutercompany/api_router/blob/main/pkg/gateway/metrics/registry.go

## Overview

**What:** Wraps a Prometheus registry with gateway-friendly defaults and small helper methods.

This package is intentionally tiny. It standardizes:
- how the gateway creates a Prometheus registry
- whether default Go/process collectors are registered
- how the `/metrics` HTTP handler is exposed

**Why:** Metrics wiring shows up in multiple places (server startup, tests, local tools).

Having a single constructor avoids subtle issues like:
- registering default collectors multiple times (panic on duplicate registration)
- forgetting to expose a handler for the correct registry (accidentally using the global Prometheus registry)
- inconsistent naming conventions across packages

**How:** Call `NewRegistry(...)` early during runtime wiring. It constructs an isolated `prometheus.Registry`,
optionally registers the standard Go and process collectors, and returns a small wrapper.

Downstream code can then:
- use `Handler()` to mount `/metrics`
- use `Register()` to add custom collectors to the same registry
- use `Raw()` for advanced Prometheus APIs when needed

**Notes:** The `namespace` field is advisory. This package does not automatically rewrite metric names.
If you want namespaced metrics, incorporate `Registry.Namespace()` when building collectors.


## Imports

### `import` block 1

```go title="pkg/gateway/metrics/registry.go#L3" showLineNumbers
import (
	"net/http"
	"strings"

	"github.com/prometheus/client_golang/prometheus"
	"github.com/prometheus/client_golang/prometheus/collectors"
	"github.com/prometheus/client_golang/prometheus/promhttp"
)
```


## Types

### `type` block 1

```go title="pkg/gateway/metrics/registry.go#L13" showLineNumbers
type Option func(*options)
```

#### `Option`

**What:** Functional option used to configure `NewRegistry`.

**Why:** Keeps the `NewRegistry` signature stable while allowing future tuning knobs.

**How:** Each option mutates an internal `options` struct.

### `type` block 2

```go title="pkg/gateway/metrics/registry.go#L15" showLineNumbers
type options struct {
	namespace                 string
	registerDefaultCollectors bool
}
```

#### `options`

**What:** Internal settings used while constructing a `Registry`.

**Why:** Separates construction-time configuration from the exported wrapper type.

**How:** Populated by `Option` functions and read by `NewRegistry`.

### `type` block 3

```go title="pkg/gateway/metrics/registry.go#L39" showLineNumbers
type Registry struct {
	namespace string
	registry  *prometheus.Registry
}
```

#### `Registry`

**What:** Wrapper that holds the namespace string and the underlying Prometheus registry.

**Why:** Makes it easy to pass around "the gateway's registry" without exposing all Prometheus types everywhere.

**How:** Constructed by `NewRegistry` and consumed by server/runtime wiring and metrics producers.


## Functions and Methods

### `WithNamespace`

**What:** Sets an optional namespace string on the registry wrapper.

**Why:** Provides a shared convention for metric naming across packages without forcing it on every call site.

**How:** Trims whitespace and stores the namespace in internal `options`; later exposed via `(*Registry).Namespace()`.

**Notes:** This does not automatically prefix metric names; callers must incorporate it when constructing metrics.

```go title="pkg/gateway/metrics/registry.go#L23" showLineNumbers
func WithNamespace(namespace string) Option {
	return func(o *options) {
		o.namespace = strings.TrimSpace(namespace)
	}
}
```

### `WithoutDefaultCollectors`

**What:** Disables automatic registration of Go/process collectors.

**Why:** Useful in tests (avoid noisy metrics) and in embeddings where another component already registers collectors.

**How:** Sets `registerDefaultCollectors` to false in internal `options`.

```go title="pkg/gateway/metrics/registry.go#L31" showLineNumbers
func WithoutDefaultCollectors() Option {
	return func(o *options) {
		o.registerDefaultCollectors = false
	}
}
```

### `NewRegistry`

**What:** Constructs a new gateway metrics registry.

**Why:** Ensures each gateway runtime instance has an isolated Prometheus registry with consistent defaults.

**How:** Applies provided options, creates a new `prometheus.Registry`, optionally registers Go/process collectors, and returns a `Registry` wrapper.

```go title="pkg/gateway/metrics/registry.go#L46" showLineNumbers
func NewRegistry(opts ...Option) *Registry {
	settings := options{
		registerDefaultCollectors: true,
	}
	for _, opt := range opts {
		if opt != nil {
			opt(&settings)
		}
	}

	reg := prometheus.NewRegistry()
	if settings.registerDefaultCollectors {
		reg.MustRegister(collectors.NewGoCollector())
		reg.MustRegister(collectors.NewProcessCollector(collectors.ProcessCollectorOpts{}))
	}

	return &Registry{
		namespace: settings.namespace,
		registry:  reg,
	}
}
```

### `(*Registry).Namespace`

**What:** Returns the configured namespace string (or empty).

**Why:** Allows metric constructors in other packages to follow a consistent naming convention.

**How:** Returns `r.namespace` with nil-safety.

```go title="pkg/gateway/metrics/registry.go#L69" showLineNumbers
func (r *Registry) Namespace() string {
	if r == nil {
		return ""
	}
	return r.namespace
}
```

### `(*Registry).Handler`

**What:** Returns an HTTP handler that serves Prometheus metrics for this registry.

**Why:** Keeps `/metrics` wiring simple and avoids accidentally using the global Prometheus registry.

**How:** Uses `promhttp.HandlerFor(r.registry, ...)` and returns `http.NotFoundHandler()` when the receiver/registry is nil.

```go title="pkg/gateway/metrics/registry.go#L78" showLineNumbers
func (r *Registry) Handler() http.Handler {
	if r == nil || r.registry == nil {
		return http.NotFoundHandler()
	}
	return promhttp.HandlerFor(r.registry, promhttp.HandlerOpts{})
}
```

### `(*Registry).Register`

**What:** Registers a collector with this registry.

**Why:** Central place to add custom gateway metrics while sharing the same registry instance.

**How:** Calls `MustRegister` on the underlying registry when the receiver and collector are non-nil.

**Notes:** Prometheus `MustRegister` panics on registration errors (e.g., duplicate descriptors).

```go title="pkg/gateway/metrics/registry.go#L88" showLineNumbers
func (r *Registry) Register(c prometheus.Collector) {
	if r == nil || r.registry == nil || c == nil {
		return
	}
	r.registry.MustRegister(c)
}
```

### `(*Registry).Raw`

**What:** Exposes the underlying `*prometheus.Registry`.

**Why:** Some integrations need Prometheus APIs not covered by this wrapper.

**How:** Returns `r.registry` with nil-safety.

```go title="pkg/gateway/metrics/registry.go#L96" showLineNumbers
func (r *Registry) Raw() *prometheus.Registry {
	if r == nil {
		return nil
	}
	return r.registry
}
```

