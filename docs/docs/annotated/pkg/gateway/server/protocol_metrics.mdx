---
title: "pkg/gateway/server/protocol_metrics.go"
---

<!--
Generated by `go run ./cmd/docsgen`.
Do not edit this file directly.
Edit commentary in `docs/annotations/pkg/gateway/server/protocol_metrics.yaml`.
-->

## Source

- Package: `server`
- File: `pkg/gateway/server/protocol_metrics.go`
- GitHub: https://github.com/theroutercompany/api_router/blob/main/pkg/gateway/server/protocol_metrics.go

## Overview

**What:** This page documents the declarations in this file.

**Why:** These docs exist to make onboarding and code review faster by explaining intent, not just mechanics.

**How:** Use the sections below to jump to the symbol you care about, then follow the links back to source.


## Imports

### `import` block 1

```go title="pkg/gateway/server/protocol_metrics.go#L3" showLineNumbers
import (
	"net/http"
	"strings"
	"time"

	"github.com/prometheus/client_golang/prometheus"

	gatewaymetrics "github.com/theroutercompany/api_router/pkg/gateway/metrics"
)
```


## Types

### `type` block 1

```go title="pkg/gateway/server/protocol_metrics.go#L13" showLineNumbers
type protocolMetrics struct {
	requests    *prometheus.CounterVec
	inflight    *prometheus.GaugeVec
	duration    *prometheus.HistogramVec
	connections *prometheus.GaugeVec
}
```

#### `protocolMetrics`

**What:** Declare `type protocolMetrics`.

**Why:** Centralizes behavior and avoids duplication in call sites.

**How:** See the Go snippet and the source link for behavior and usage.


## Functions and Methods

### `newProtocolMetrics`

**What:** Declare `func newProtocolMetrics`.

**Why:** Centralizes behavior and avoids duplication in call sites.

**How:** See the Go snippet and the source link for behavior and usage.

```go title="pkg/gateway/server/protocol_metrics.go#L20" showLineNumbers
func newProtocolMetrics(reg *gatewaymetrics.Registry) *protocolMetrics {
	if reg == nil {
		return nil
	}

	requests := prometheus.NewCounterVec(prometheus.CounterOpts{
		Name: "gateway_protocol_requests_total",
		Help: "Count of proxied requests labelled by protocol, product, and outcome.",
	}, []string{"protocol", "product", "outcome"})

	inflight := prometheus.NewGaugeVec(prometheus.GaugeOpts{
		Name: "gateway_protocol_inflight",
		Help: "Current number of in-flight proxied requests by protocol and product.",
	}, []string{"protocol", "product"})

	duration := prometheus.NewHistogramVec(prometheus.HistogramOpts{
		Name:    "gateway_protocol_request_duration_seconds",
		Help:    "Upstream duration for proxied requests segmented by protocol and product.",
		Buckets: prometheus.DefBuckets,
	}, []string{"protocol", "product"})

	connections := prometheus.NewGaugeVec(prometheus.GaugeOpts{
		Name: "gateway_protocol_active_connections",
		Help: "Current number of active upgraded connections (e.g., websockets) by protocol and product.",
	}, []string{"protocol", "product"})

	reg.Register(requests)
	reg.Register(inflight)
	reg.Register(duration)
	reg.Register(connections)

	return &protocolMetrics{
		requests:    requests,
		inflight:    inflight,
		duration:    duration,
		connections: connections,
	}
}
```

### `(*protocolMetrics).track`

**What:** Declare `method (*protocolMetrics).track`.

**Why:** Centralizes behavior and avoids duplication in call sites.

**How:** See the Go snippet and the source link for behavior and usage.

```go title="pkg/gateway/server/protocol_metrics.go#L59" showLineNumbers
func (m *protocolMetrics) track(r *http.Request) func(status int, elapsed time.Duration) {
	if m == nil || r == nil {
		return func(int, time.Duration) {}
	}

	protocol := classifyProtocol(r)
	product := productFromRequest(r)

	if m.inflight != nil {
		m.inflight.WithLabelValues(protocol, product).Inc()
	}

	trackConnection := m.connections != nil && trackConnectionForProtocol(protocol)
	if trackConnection {
		m.connections.WithLabelValues(protocol, product).Inc()
	}

	return func(status int, elapsed time.Duration) {
		if status <= 0 {
			status = http.StatusOK
		}

		outcome := "success"
		if status >= 400 {
			outcome = "error"
		}

		if m.requests != nil {
			m.requests.WithLabelValues(protocol, product, outcome).Inc()
		}
		if m.duration != nil {
			m.duration.WithLabelValues(protocol, product).Observe(elapsed.Seconds())
		}
		if m.inflight != nil {
			m.inflight.WithLabelValues(protocol, product).Dec()
		}
		if trackConnection {
			m.connections.WithLabelValues(protocol, product).Dec()
		}
	}
}
```

### `(*protocolMetrics).hijacked`

**What:** Declare `method (*protocolMetrics).hijacked`.

**Why:** Centralizes behavior and avoids duplication in call sites.

**How:** See the Go snippet and the source link for behavior and usage.

```go title="pkg/gateway/server/protocol_metrics.go#L101" showLineNumbers
func (m *protocolMetrics) hijacked(r *http.Request) func() {
	if m == nil || m.connections == nil || r == nil {
		return nil
	}

	protocol := classifyProtocol(r)
	if protocol != "websocket" {
		return nil
	}

	product := productFromRequest(r)
	m.connections.WithLabelValues(protocol, product).Inc()
	return func() {
		m.connections.WithLabelValues(protocol, product).Dec()
	}
}
```

### `trackConnectionForProtocol`

**What:** Declare `func trackConnectionForProtocol`.

**Why:** Centralizes behavior and avoids duplication in call sites.

**How:** See the Go snippet and the source link for behavior and usage.

```go title="pkg/gateway/server/protocol_metrics.go#L118" showLineNumbers
func trackConnectionForProtocol(protocol string) bool {
	switch protocol {
	case "sse", "grpc":
		return true
	default:
		return false
	}
}
```

### `classifyProtocol`

**What:** Declare `func classifyProtocol`.

**Why:** Centralizes behavior and avoids duplication in call sites.

**How:** See the Go snippet and the source link for behavior and usage.

```go title="pkg/gateway/server/protocol_metrics.go#L127" showLineNumbers
func classifyProtocol(r *http.Request) string {
	if r == nil {
		return "unknown"
	}

	accept := strings.ToLower(r.Header.Get("Accept"))
	contentType := strings.ToLower(r.Header.Get("Content-Type"))

	if strings.Contains(accept, "text/event-stream") || strings.HasPrefix(contentType, "text/event-stream") {
		return "sse"
	}

	if upgrade := r.Header.Get("Upgrade"); upgrade != "" && strings.EqualFold(upgrade, "websocket") {
		return "websocket"
	}

	if connection := r.Header.Get("Connection"); connection != "" && strings.Contains(strings.ToLower(connection), "upgrade") {
		if strings.EqualFold(r.Header.Get("Upgrade"), "websocket") {
			return "websocket"
		}
	}

	if strings.HasPrefix(contentType, "application/grpc") {
		return "grpc"
	}

	if r.Header.Get("Grpc-Timeout") != "" {
		return "grpc"
	}

	if r.ProtoMajor == 2 && strings.Contains(strings.ToLower(r.Header.Get("TE")), "trailers") && strings.HasPrefix(contentType, "application/") {
		return "grpc"
	}

	return "http"
}
```

### `productFromRequest`

**What:** Declare `func productFromRequest`.

**Why:** Centralizes behavior and avoids duplication in call sites.

**How:** See the Go snippet and the source link for behavior and usage.

```go title="pkg/gateway/server/protocol_metrics.go#L164" showLineNumbers
func productFromRequest(r *http.Request) string {
	if r == nil {
		return "unknown"
	}

	if product := r.Header.Get("X-Router-Product"); product != "" {
		return product
	}

	path := r.URL.Path
	switch {
	case strings.HasPrefix(path, "/v1/trade"):
		return "trade"
	case strings.HasPrefix(path, "/v1/task"):
		return "task"
	default:
		return "unknown"
	}
}
```

