---
title: "pkg/gateway/server/middleware/middleware.go"
---

<!--
Generated by `go run ./cmd/docsgen`.
Do not edit this file directly.
Edit commentary in `docs/annotations/pkg/gateway/server/middleware/middleware.yaml`.
-->

## Source

- Package: `middleware`
- File: `pkg/gateway/server/middleware/middleware.go`
- GitHub: https://github.com/theroutercompany/api_router/blob/main/pkg/gateway/server/middleware/middleware.go

## Overview

**What:** This page documents the declarations in this file.

**Why:** These docs exist to make onboarding and code review faster by explaining intent, not just mechanics.

**How:** Use the sections below to jump to the symbol you care about, then follow the links back to source.


## Imports

### `import` block 1

```go title="pkg/gateway/server/middleware/middleware.go#L3" showLineNumbers
import (
	"bufio"
	"context"
	"errors"
	"fmt"
	"net"
	"net/http"
	"strings"
	"sync"
	"time"

	"github.com/rs/cors"
)
```


## Types

### `type` block 1

```go title="pkg/gateway/server/middleware/middleware.go#L18" showLineNumbers
type Logger interface {
	Infow(msg string, keysAndValues ...any)
	Warnw(msg string, keysAndValues ...any)
	Errorw(msg string, keysAndValues ...any)
}
```

#### `Logger`

**What:** Declare `type Logger`.

**Why:** Centralizes behavior and avoids duplication in call sites.

**How:** See the Go snippet and the source link for behavior and usage.

### `type` block 2

```go title="pkg/gateway/server/middleware/middleware.go#L25" showLineNumbers
type ProblemWriter func(w http.ResponseWriter, status int, title, detail, traceID, instance string)
```

#### `ProblemWriter`

**What:** Declare `type ProblemWriter`.

**Why:** Centralizes behavior and avoids duplication in call sites.

**How:** See the Go snippet and the source link for behavior and usage.

### `type` block 3

```go title="pkg/gateway/server/middleware/middleware.go#L28" showLineNumbers
type EnsureIDs func(*http.Request) (*http.Request, string, string)
```

#### `EnsureIDs`

**What:** Declare `type EnsureIDs`.

**Why:** Centralizes behavior and avoids duplication in call sites.

**How:** See the Go snippet and the source link for behavior and usage.

### `type` block 4

```go title="pkg/gateway/server/middleware/middleware.go#L31" showLineNumbers
type TraceIDFromContext func(context.Context) string
```

#### `TraceIDFromContext`

**What:** Declare `type TraceIDFromContext`.

**Why:** Centralizes behavior and avoids duplication in call sites.

**How:** See the Go snippet and the source link for behavior and usage.

### `type` block 5

```go title="pkg/gateway/server/middleware/middleware.go#L34" showLineNumbers
type RequestIDFromContext func(context.Context) string
```

#### `RequestIDFromContext`

**What:** Declare `type RequestIDFromContext`.

**Why:** Centralizes behavior and avoids duplication in call sites.

**How:** See the Go snippet and the source link for behavior and usage.

### `type` block 6

```go title="pkg/gateway/server/middleware/middleware.go#L37" showLineNumbers
type ClientAddress func(*http.Request) string
```

#### `ClientAddress`

**What:** Declare `type ClientAddress`.

**Why:** Centralizes behavior and avoids duplication in call sites.

**How:** See the Go snippet and the source link for behavior and usage.

### `type` block 7

```go title="pkg/gateway/server/middleware/middleware.go#L40" showLineNumbers
type TrackFunc func(*http.Request) func(status int, elapsed time.Duration)
```

#### `TrackFunc`

**What:** Declare `type TrackFunc`.

**Why:** Centralizes behavior and avoids duplication in call sites.

**How:** See the Go snippet and the source link for behavior and usage.

### `type` block 8

```go title="pkg/gateway/server/middleware/middleware.go#L43" showLineNumbers
type HijackedFunc func(*http.Request) (func(), func(net.Conn) net.Conn)
```

#### `HijackedFunc`

**What:** Declare `type HijackedFunc`.

**Why:** Centralizes behavior and avoids duplication in call sites.

**How:** See the Go snippet and the source link for behavior and usage.

### `type` block 9

```go title="pkg/gateway/server/middleware/middleware.go#L46" showLineNumbers
type AllowFunc func(key string, now time.Time) bool
```

#### `AllowFunc`

**What:** Declare `type AllowFunc`.

**Why:** Centralizes behavior and avoids duplication in call sites.

**How:** See the Go snippet and the source link for behavior and usage.

### `type` block 10

```go title="pkg/gateway/server/middleware/middleware.go#L49" showLineNumbers
type ClientKey func(*http.Request) string
```

#### `ClientKey`

**What:** Declare `type ClientKey`.

**Why:** Centralizes behavior and avoids duplication in call sites.

**How:** See the Go snippet and the source link for behavior and usage.

### `type` block 11

```go title="pkg/gateway/server/middleware/middleware.go#L249" showLineNumbers
type loggingResponseWriter struct {
	http.ResponseWriter
	status        int
	bytes         int
	hijackTracker func() (func(), func(net.Conn) net.Conn)
	hijackOnce    sync.Once
}
```

#### `loggingResponseWriter`

**What:** Declare `type loggingResponseWriter`.

**Why:** Centralizes behavior and avoids duplication in call sites.

**How:** See the Go snippet and the source link for behavior and usage.

### `type` block 12

```go title="pkg/gateway/server/middleware/middleware.go#L319" showLineNumbers
type trackingConn struct {
	net.Conn
	onClose func()
	once    sync.Once
	timeout time.Duration
}
```

#### `trackingConn`

**What:** Declare `type trackingConn`.

**Why:** Centralizes behavior and avoids duplication in call sites.

**How:** See the Go snippet and the source link for behavior and usage.


## Functions and Methods

### `RequestMetadata`

**What:** Declare `func RequestMetadata`.

**Why:** Centralizes behavior and avoids duplication in call sites.

**How:** See the Go snippet and the source link for behavior and usage.

```go title="pkg/gateway/server/middleware/middleware.go#L52" showLineNumbers
func RequestMetadata(ensure EnsureIDs) func(http.Handler) http.Handler {
	if ensure == nil {
		return func(next http.Handler) http.Handler { return next }
	}

	return func(next http.Handler) http.Handler {
		if next == nil {
			return http.HandlerFunc(func(http.ResponseWriter, *http.Request) {})
		}
		return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
			req, requestID, traceID := ensure(r)
			w.Header().Set("X-Request-Id", requestID)
			if traceID != "" {
				w.Header().Set("X-Trace-Id", traceID)
			}
			next.ServeHTTP(w, req)
		})
	}
}
```

### `SecurityHeaders`

**What:** Declare `func SecurityHeaders`.

**Why:** Centralizes behavior and avoids duplication in call sites.

**How:** See the Go snippet and the source link for behavior and usage.

```go title="pkg/gateway/server/middleware/middleware.go#L73" showLineNumbers
func SecurityHeaders() func(http.Handler) http.Handler {
	return func(next http.Handler) http.Handler {
		if next == nil {
			return http.HandlerFunc(func(http.ResponseWriter, *http.Request) {})
		}
		return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
			headers := w.Header()
			headers.Set("X-Content-Type-Options", "nosniff")
			headers.Set("X-Frame-Options", "DENY")
			headers.Set("Referrer-Policy", "no-referrer")
			headers.Set("Permissions-Policy", "geolocation=(), microphone=(), camera=()")
			next.ServeHTTP(w, r)
		})
	}
}
```

### `BodyLimit`

**What:** Declare `func BodyLimit`.

**Why:** Centralizes behavior and avoids duplication in call sites.

**How:** See the Go snippet and the source link for behavior and usage.

```go title="pkg/gateway/server/middleware/middleware.go#L90" showLineNumbers
func BodyLimit(limit int64, trace TraceIDFromContext, write ProblemWriter) func(http.Handler) http.Handler {
	return func(next http.Handler) http.Handler {
		if next == nil {
			return http.HandlerFunc(func(http.ResponseWriter, *http.Request) {})
		}
		return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
			if r.ContentLength > limit {
				tid := ""
				if trace != nil {
					tid = trace(r.Context())
				}
				if write != nil {
					write(w, http.StatusRequestEntityTooLarge, "Payload Too Large", fmt.Sprintf("Request body exceeds %d bytes", limit), tid, r.URL.Path)
					return
				}
				http.Error(w, http.StatusText(http.StatusRequestEntityTooLarge), http.StatusRequestEntityTooLarge)
				return
			}
			if r.Body != nil {
				r.Body = http.MaxBytesReader(w, r.Body, limit)
			}
			next.ServeHTTP(w, r)
		})
	}
}
```

### `RateLimit`

**What:** Declare `func RateLimit`.

**Why:** Centralizes behavior and avoids duplication in call sites.

**How:** See the Go snippet and the source link for behavior and usage.

```go title="pkg/gateway/server/middleware/middleware.go#L117" showLineNumbers
func RateLimit(allow AllowFunc, key ClientKey, now func() time.Time, trace TraceIDFromContext, write ProblemWriter) func(http.Handler) http.Handler {
	return func(next http.Handler) http.Handler {
		if next == nil || allow == nil || key == nil || now == nil {
			return next
		}
		return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
			if r.Method == http.MethodOptions {
				next.ServeHTTP(w, r)
				return
			}
			client := key(r)
			if allow(client, now()) {
				next.ServeHTTP(w, r)
				return
			}
			if write != nil {
				tid := ""
				if trace != nil {
					tid = trace(r.Context())
				}
				write(w, http.StatusTooManyRequests, "Too Many Requests", "Rate limit exceeded", tid, r.URL.Path)
			} else {
				http.Error(w, http.StatusText(http.StatusTooManyRequests), http.StatusTooManyRequests)
			}
		})
	}
}
```

### `CORS`

**What:** Declare `func CORS`.

**Why:** Centralizes behavior and avoids duplication in call sites.

**How:** See the Go snippet and the source link for behavior and usage.

```go title="pkg/gateway/server/middleware/middleware.go#L146" showLineNumbers
func CORS(handler *cors.Cors, trace TraceIDFromContext, write ProblemWriter) func(http.Handler) http.Handler {
	return func(next http.Handler) http.Handler {
		if handler == nil || next == nil {
			return next
		}
		corsHandler := handler.Handler(next)
		return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
			origin := strings.TrimSpace(r.Header.Get("Origin"))
			if origin != "" && !handler.OriginAllowed(r) {
				if write != nil {
					tid := ""
					if trace != nil {
						tid = trace(r.Context())
					}
					write(w, http.StatusForbidden, "Not allowed by CORS", fmt.Sprintf("Origin %s is not allowed", origin), tid, r.URL.Path)
				} else {
					http.Error(w, http.StatusText(http.StatusForbidden), http.StatusForbidden)
				}
				return
			}
			corsHandler.ServeHTTP(w, r)
		})
	}
}
```

### `Logging`

**What:** Declare `func Logging`.

**Why:** Centralizes behavior and avoids duplication in call sites.

**How:** See the Go snippet and the source link for behavior and usage.

```go title="pkg/gateway/server/middleware/middleware.go#L172" showLineNumbers
func Logging(
	logger Logger,
	track TrackFunc,
	hijacked HijackedFunc,
	requestID RequestIDFromContext,
	traceID TraceIDFromContext,
	clientAddr ClientAddress,
) func(http.Handler) http.Handler {
	return func(next http.Handler) http.Handler {
		if next == nil || logger == nil {
			return next
		}

		return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
			start := time.Now()

			trackFn := func(int, time.Duration) {}
			if track != nil {
				if fn := track(r); fn != nil {
					trackFn = fn
				}
			}

			var hijackTracker func() (func(), func(net.Conn) net.Conn)
			if hijacked != nil {
				hijackTracker = func() (func(), func(net.Conn) net.Conn) {
					return hijacked(r)
				}
			}

			writer := newLoggingResponseWriter(w, hijackTracker)
			next.ServeHTTP(writer, r)

			duration := time.Since(start)
			status := writer.status
			if status == 0 {
				status = http.StatusOK
			}

			trackFn(status, duration)

			fields := []any{
				"method", r.Method,
				"path", r.URL.Path,
				"status", status,
				"durationMs", float64(duration.Microseconds()) / 1000.0,
				"bytesWritten", writer.bytes,
			}

			if requestID != nil {
				if rid := requestID(r.Context()); rid != "" {
					fields = append(fields, "requestId", rid)
				}
			}
			if traceID != nil {
				if tid := traceID(r.Context()); tid != "" {
					fields = append(fields, "traceId", tid)
				}
			}
			if clientAddr != nil {
				if remote := clientAddr(r); remote != "" {
					fields = append(fields, "remoteAddr", remote)
				}
			}

			switch {
			case status >= 500:
				logger.Errorw("http request completed", fields...)
			case status >= 400:
				logger.Warnw("http request completed", fields...)
			default:
				logger.Infow("http request completed", fields...)
			}
		})
	}
}
```

### `newLoggingResponseWriter`

**What:** Declare `func newLoggingResponseWriter`.

**Why:** Centralizes behavior and avoids duplication in call sites.

**How:** See the Go snippet and the source link for behavior and usage.

```go title="pkg/gateway/server/middleware/middleware.go#L257" showLineNumbers
func newLoggingResponseWriter(w http.ResponseWriter, tracker func() (func(), func(net.Conn) net.Conn)) *loggingResponseWriter {
	return &loggingResponseWriter{
		ResponseWriter: w,
		status:         http.StatusOK,
		hijackTracker:  tracker,
	}
}
```

### `(*loggingResponseWriter).WriteHeader`

**What:** Declare `method (*loggingResponseWriter).WriteHeader`.

**Why:** Centralizes behavior and avoids duplication in call sites.

**How:** See the Go snippet and the source link for behavior and usage.

```go title="pkg/gateway/server/middleware/middleware.go#L265" showLineNumbers
func (w *loggingResponseWriter) WriteHeader(status int) {
	w.status = status
	w.ResponseWriter.WriteHeader(status)
}
```

### `(*loggingResponseWriter).Write`

**What:** Declare `method (*loggingResponseWriter).Write`.

**Why:** Centralizes behavior and avoids duplication in call sites.

**How:** See the Go snippet and the source link for behavior and usage.

```go title="pkg/gateway/server/middleware/middleware.go#L270" showLineNumbers
func (w *loggingResponseWriter) Write(b []byte) (int, error) {
	if w.status == 0 {
		w.status = http.StatusOK
	}
	n, err := w.ResponseWriter.Write(b)
	w.bytes += n
	return n, err
}
```

### `(*loggingResponseWriter).Flush`

**What:** Declare `method (*loggingResponseWriter).Flush`.

**Why:** Centralizes behavior and avoids duplication in call sites.

**How:** See the Go snippet and the source link for behavior and usage.

```go title="pkg/gateway/server/middleware/middleware.go#L279" showLineNumbers
func (w *loggingResponseWriter) Flush() {
	if flusher, ok := w.ResponseWriter.(http.Flusher); ok {
		flusher.Flush()
	}
}
```

### `(*loggingResponseWriter).Hijack`

**What:** Declare `method (*loggingResponseWriter).Hijack`.

**Why:** Centralizes behavior and avoids duplication in call sites.

**How:** See the Go snippet and the source link for behavior and usage.

```go title="pkg/gateway/server/middleware/middleware.go#L285" showLineNumbers
func (w *loggingResponseWriter) Hijack() (net.Conn, *bufio.ReadWriter, error) {
	hijacker, ok := w.ResponseWriter.(http.Hijacker)
	if !ok {
		return nil, nil, errors.New("hijacker not supported")
	}
	conn, rw, err := hijacker.Hijack()
	if err != nil {
		return nil, nil, err
	}

	if w.hijackTracker != nil {
		var closer func()
		var wrapper func(net.Conn) net.Conn
		w.hijackOnce.Do(func() {
			closer, wrapper = w.hijackTracker()
		})
		if wrapper != nil {
			conn = wrapper(conn)
		}
		if closer != nil {
			conn = &trackingConn{Conn: conn, onClose: closer}
		}
	}

	return conn, rw, nil
}
```

### `(*loggingResponseWriter).Push`

**What:** Declare `method (*loggingResponseWriter).Push`.

**Why:** Centralizes behavior and avoids duplication in call sites.

**How:** See the Go snippet and the source link for behavior and usage.

```go title="pkg/gateway/server/middleware/middleware.go#L312" showLineNumbers
func (w *loggingResponseWriter) Push(target string, opts *http.PushOptions) error {
	if pusher, ok := w.ResponseWriter.(http.Pusher); ok {
		return pusher.Push(target, opts)
	}
	return http.ErrNotSupported
}
```

### `(*trackingConn).Close`

**What:** Declare `method (*trackingConn).Close`.

**Why:** Centralizes behavior and avoids duplication in call sites.

**How:** See the Go snippet and the source link for behavior and usage.

```go title="pkg/gateway/server/middleware/middleware.go#L326" showLineNumbers
func (c *trackingConn) Close() error {
	err := c.Conn.Close()
	c.once.Do(func() {
		if c.onClose != nil {
			c.onClose()
		}
	})
	return err
}
```

### `(*trackingConn).Read`

**What:** Declare `method (*trackingConn).Read`.

**Why:** Centralizes behavior and avoids duplication in call sites.

**How:** See the Go snippet and the source link for behavior and usage.

```go title="pkg/gateway/server/middleware/middleware.go#L336" showLineNumbers
func (c *trackingConn) Read(b []byte) (int, error) {
	if c.timeout > 0 {
		_ = c.Conn.SetReadDeadline(time.Now().Add(c.timeout))
	}
	return c.Conn.Read(b)
}
```

### `(*trackingConn).Write`

**What:** Declare `method (*trackingConn).Write`.

**Why:** Centralizes behavior and avoids duplication in call sites.

**How:** See the Go snippet and the source link for behavior and usage.

```go title="pkg/gateway/server/middleware/middleware.go#L343" showLineNumbers
func (c *trackingConn) Write(b []byte) (int, error) {
	if c.timeout > 0 {
		_ = c.Conn.SetWriteDeadline(time.Now().Add(c.timeout))
	}
	return c.Conn.Write(b)
}
```

